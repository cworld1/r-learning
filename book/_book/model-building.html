<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 17 Model building | R-Learning</title>
  <meta name="description" content="这是关于 CWorld 学习 R 语言的一些笔记和代码。" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 17 Model building | R-Learning" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://cworld1.github.io/r-learning/data/avatar.jpg" />
  <meta property="og:description" content="这是关于 CWorld 学习 R 语言的一些笔记和代码。" />
  <meta name="github-repo" content="cworld1/r-learning" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 17 Model building | R-Learning" />
  
  <meta name="twitter:description" content="这是关于 CWorld 学习 R 语言的一些笔记和代码。" />
  <meta name="twitter:image" content="https://cworld1.github.io/r-learning/data/avatar.jpg" />

<meta name="author" content="CWorld" />


<meta name="date" content="2022-05-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="data/favicon.ico" type="image/x-icon" />
<link rel="prev" href="model-basics.html"/>
<link rel="next" href="introduction-1.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="assets/style.min.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="#" target="blank">R Learning Notebook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#项目介绍"><i class="fa fa-check"></i><b>1.1</b> 项目介绍</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#项目运行"><i class="fa fa-check"></i><b>1.2</b> 项目运行</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#贡献"><i class="fa fa-check"></i><b>1.3</b> 贡献</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#鸣谢"><i class="fa fa-check"></i><b>1.4</b> 鸣谢</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i><b>1.5</b> License</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#数据科学"><i class="fa fa-check"></i><b>2.1</b> 数据科学</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#一些准备"><i class="fa fa-check"></i><b>2.2</b> 一些准备</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#安装-r"><i class="fa fa-check"></i><b>2.2.1</b> 安装 R</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#安装编辑器"><i class="fa fa-check"></i><b>2.2.2</b> 安装编辑器</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction.html"><a href="introduction.html#相关包"><i class="fa fa-check"></i><b>2.2.3</b> 相关包</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#更多学习途径"><i class="fa fa-check"></i><b>2.3</b> 更多学习途径</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#初识-r"><i class="fa fa-check"></i><b>2.4</b> 初识 R</a></li>
</ul></li>
<li class="part"><span><b>I Explore 探索</b></span></li>
<li class="chapter" data-level="3" data-path="explore-intro.html"><a href="explore-intro.html"><i class="fa fa-check"></i><b>3</b> Introduction</a>
<ul>
<li class="chapter" data-level="3.1" data-path="explore-intro.html"><a href="explore-intro.html#基本数据形式和函数"><i class="fa fa-check"></i><b>3.1</b> 基本数据形式和函数</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="explore-intro.html"><a href="explore-intro.html#向量矩阵与列表"><i class="fa fa-check"></i><b>3.1.1</b> 向量、矩阵与列表</a></li>
<li class="chapter" data-level="3.1.2" data-path="explore-intro.html"><a href="explore-intro.html#基本函数"><i class="fa fa-check"></i><b>3.1.2</b> 基本函数</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="explore-intro.html"><a href="explore-intro.html#学习-r-自带的画图功能"><i class="fa fa-check"></i><b>3.2</b> 学习 R 自带的画图功能</a></li>
<li class="chapter" data-level="3.3" data-path="explore-intro.html"><a href="explore-intro.html#更高级的数据形式"><i class="fa fa-check"></i><b>3.3</b> 更高级的数据形式</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="explore.html"><a href="explore.html"><i class="fa fa-check"></i><b>4</b> Data visualisation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="explore.html"><a href="explore.html#初识-ggplot"><i class="fa fa-check"></i><b>4.1</b> 初识 ggplot</a></li>
<li class="chapter" data-level="4.2" data-path="explore.html"><a href="explore.html#美学映射"><i class="fa fa-check"></i><b>4.2</b> 美学映射</a></li>
<li class="chapter" data-level="4.3" data-path="explore.html"><a href="explore.html#修改样式"><i class="fa fa-check"></i><b>4.3</b> 修改样式</a></li>
<li class="chapter" data-level="4.4" data-path="explore.html"><a href="explore.html#多组画图"><i class="fa fa-check"></i><b>4.4</b> 多组画图</a></li>
<li class="chapter" data-level="4.5" data-path="explore.html"><a href="explore.html#叠加与参数"><i class="fa fa-check"></i><b>4.5</b> 叠加与参数</a></li>
<li class="chapter" data-level="4.6" data-path="explore.html"><a href="explore.html#其他常见图"><i class="fa fa-check"></i><b>4.6</b> 其他常见图</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="explore.html"><a href="explore.html#回归曲线图"><i class="fa fa-check"></i><b>4.6.1</b> 回归曲线图</a></li>
<li class="chapter" data-level="4.6.2" data-path="explore.html"><a href="explore.html#条形图"><i class="fa fa-check"></i><b>4.6.2</b> 条形图</a></li>
<li class="chapter" data-level="4.6.3" data-path="explore.html"><a href="explore.html#summary-线条信息图"><i class="fa fa-check"></i><b>4.6.3</b> Summary 线条信息图</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="explore.html"><a href="explore.html#坐标系相关"><i class="fa fa-check"></i><b>4.7</b> 坐标系相关</a></li>
<li class="chapter" data-level="4.8" data-path="explore.html"><a href="explore.html#绘制-diamonds-数据分析图"><i class="fa fa-check"></i><b>4.8</b> 绘制 diamonds 数据分析图</a></li>
<li class="chapter" data-level="4.9" data-path="explore.html"><a href="explore.html#研究-mpgcars-数据集"><i class="fa fa-check"></i><b>4.9</b> 研究 mpgcars 数据集</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="workflow-basics.html"><a href="workflow-basics.html"><i class="fa fa-check"></i><b>5</b> Workflow: basics</a></li>
<li class="chapter" data-level="6" data-path="transform.html"><a href="transform.html"><i class="fa fa-check"></i><b>6</b> Data transformation</a>
<ul>
<li class="chapter" data-level="6.1" data-path="transform.html"><a href="transform.html#查看-flights-数据集"><i class="fa fa-check"></i><b>6.1</b> 查看 flights 数据集</a></li>
<li class="chapter" data-level="6.2" data-path="transform.html"><a href="transform.html#过滤-filter"><i class="fa fa-check"></i><b>6.2</b> 过滤 filter()</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="transform.html"><a href="transform.html#比较"><i class="fa fa-check"></i><b>6.2.1</b> 比较</a></li>
<li class="chapter" data-level="6.2.2" data-path="transform.html"><a href="transform.html#逻辑运算符"><i class="fa fa-check"></i><b>6.2.2</b> 逻辑运算符</a></li>
<li class="chapter" data-level="6.2.3" data-path="transform.html"><a href="transform.html#缺失值"><i class="fa fa-check"></i><b>6.2.3</b> 缺失值</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="transform.html"><a href="transform.html#排列-arange"><i class="fa fa-check"></i><b>6.3</b> 排列 arange()</a></li>
<li class="chapter" data-level="6.4" data-path="transform.html"><a href="transform.html#选择-select"><i class="fa fa-check"></i><b>6.4</b> 选择 select()</a></li>
<li class="chapter" data-level="6.5" data-path="transform.html"><a href="transform.html#重命名-rename"><i class="fa fa-check"></i><b>6.5</b> 重命名 rename()</a></li>
<li class="chapter" data-level="6.6" data-path="transform.html"><a href="transform.html#添加新变量-mutate-与-transmute"><i class="fa fa-check"></i><b>6.6</b> 添加新变量 mutate() 与 transmute()</a></li>
<li class="chapter" data-level="6.7" data-path="transform.html"><a href="transform.html#分组摘要-summarise"><i class="fa fa-check"></i><b>6.7</b> 分组摘要 summarise()</a></li>
<li class="chapter" data-level="6.8" data-path="transform.html"><a href="transform.html#其他处理数据功能"><i class="fa fa-check"></i><b>6.8</b> 其他处理数据功能</a></li>
<li class="chapter" data-level="6.9" data-path="transform.html"><a href="transform.html#分析-flights-数据集"><i class="fa fa-check"></i><b>6.9</b> 分析 flights 数据集</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="transform.html"><a href="transform.html#计算目的地相关的图"><i class="fa fa-check"></i><b>6.9.1</b> 计算目的地相关的图</a></li>
<li class="chapter" data-level="6.9.2" data-path="transform.html"><a href="transform.html#获取热门目的地及有关数据"><i class="fa fa-check"></i><b>6.9.2</b> 获取热门目的地及有关数据</a></li>
<li class="chapter" data-level="6.9.3" data-path="transform.html"><a href="transform.html#绘制飞机延误时长分布图"><i class="fa fa-check"></i><b>6.9.3</b> 绘制飞机延误时长分布图</a></li>
<li class="chapter" data-level="6.9.4" data-path="transform.html"><a href="transform.html#计算每天最早和最晚的航班"><i class="fa fa-check"></i><b>6.9.4</b> 计算每天最早和最晚的航班</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="workflow-scripts.html"><a href="workflow-scripts.html"><i class="fa fa-check"></i><b>7</b> Workflow: scripts</a>
<ul>
<li class="chapter" data-level="7.1" data-path="workflow-scripts.html"><a href="workflow-scripts.html#运行代码"><i class="fa fa-check"></i><b>7.1</b> 运行代码</a></li>
<li class="chapter" data-level="7.2" data-path="workflow-scripts.html"><a href="workflow-scripts.html#rstudio-诊断"><i class="fa fa-check"></i><b>7.2</b> RStudio 诊断</a></li>
<li class="chapter" data-level="7.3" data-path="workflow-scripts.html"><a href="workflow-scripts.html#使用-visual-studio-code-编写-r"><i class="fa fa-check"></i><b>7.3</b> 使用 Visual studio code 编写 R</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html"><i class="fa fa-check"></i><b>8</b> Exploratory Data Analysis</a>
<ul>
<li class="chapter" data-level="8.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#绘图分析-diamonds-数据集"><i class="fa fa-check"></i><b>8.1</b> 绘图分析 diamonds 数据集</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#可视化分布"><i class="fa fa-check"></i><b>8.1.1</b> 可视化分布</a></li>
<li class="chapter" data-level="8.1.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#绘制频率直方图"><i class="fa fa-check"></i><b>8.1.2</b> 绘制频率直方图</a></li>
<li class="chapter" data-level="8.1.3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#异常数据杂质"><i class="fa fa-check"></i><b>8.1.3</b> 异常数据（杂质）</a></li>
<li class="chapter" data-level="8.1.4" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#处理异常数据"><i class="fa fa-check"></i><b>8.1.4</b> 处理异常数据</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#绘图统计-flights-数据集"><i class="fa fa-check"></i><b>8.2</b> 绘图统计 flights 数据集</a></li>
<li class="chapter" data-level="8.3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#绘图统计-diamonds-数据集"><i class="fa fa-check"></i><b>8.3</b> 绘图统计 diamonds 数据集</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#连续变量多类绘图"><i class="fa fa-check"></i><b>8.3.1</b> 连续变量多类绘图</a></li>
<li class="chapter" data-level="8.3.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#关于变量排序-reorder"><i class="fa fa-check"></i><b>8.3.2</b> 关于变量排序 reorder()</a></li>
<li class="chapter" data-level="8.3.3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#两个分类变量"><i class="fa fa-check"></i><b>8.3.3</b> 两个分类变量</a></li>
<li class="chapter" data-level="8.3.4" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#两个连续变量"><i class="fa fa-check"></i><b>8.3.4</b> 两个连续变量</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="workflow-projects.html"><a href="workflow-projects.html"><i class="fa fa-check"></i><b>9</b> Workflow: projects</a>
<ul>
<li class="chapter" data-level="9.1" data-path="workflow-projects.html"><a href="workflow-projects.html#运行环境"><i class="fa fa-check"></i><b>9.1</b> 运行环境</a></li>
<li class="chapter" data-level="9.2" data-path="workflow-projects.html"><a href="workflow-projects.html#工作区"><i class="fa fa-check"></i><b>9.2</b> 工作区</a></li>
<li class="chapter" data-level="9.3" data-path="workflow-projects.html"><a href="workflow-projects.html#路径与目录"><i class="fa fa-check"></i><b>9.3</b> 路径与目录</a></li>
<li class="chapter" data-level="9.4" data-path="workflow-projects.html"><a href="workflow-projects.html#rstudio-项目"><i class="fa fa-check"></i><b>9.4</b> RStudio 项目</a></li>
</ul></li>
<li class="part"><span><b>II Wrangle 扭结</b></span></li>
<li class="chapter" data-level="10" data-path="wrangle-intro.html"><a href="wrangle-intro.html"><i class="fa fa-check"></i><b>10</b> Introduction</a></li>
<li class="chapter" data-level="11" data-path="tibbles.html"><a href="tibbles.html"><i class="fa fa-check"></i><b>11</b> Tibbles</a>
<ul>
<li class="chapter" data-level="11.1" data-path="tibbles.html"><a href="tibbles.html#创建-tibble"><i class="fa fa-check"></i><b>11.1</b> 创建 tibble</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="tibbles.html"><a href="tibbles.html#as_tibble"><i class="fa fa-check"></i><b>11.1.1</b> as_tibble()</a></li>
<li class="chapter" data-level="11.1.2" data-path="tibbles.html"><a href="tibbles.html#tibble"><i class="fa fa-check"></i><b>11.1.2</b> tibble()</a></li>
<li class="chapter" data-level="11.1.3" data-path="tibbles.html"><a href="tibbles.html#tribble"><i class="fa fa-check"></i><b>11.1.3</b> tribble()</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="tibbles.html"><a href="tibbles.html#tibbles-vs.-data.frame"><i class="fa fa-check"></i><b>11.2</b> tibbles VS. data.frame</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="tibbles.html"><a href="tibbles.html#控制台打印方面"><i class="fa fa-check"></i><b>11.2.1</b> 控制台打印方面</a></li>
<li class="chapter" data-level="11.2.2" data-path="tibbles.html"><a href="tibbles.html#读取子元素方面"><i class="fa fa-check"></i><b>11.2.2</b> 读取子元素方面</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="tibbles.html"><a href="tibbles.html#tibble-的转换"><i class="fa fa-check"></i><b>11.3</b> tibble 的转换</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="data-import.html"><a href="data-import.html"><i class="fa fa-check"></i><b>12</b> Data import</a>
<ul>
<li class="chapter" data-level="12.1" data-path="data-import.html"><a href="data-import.html#简单读取文件"><i class="fa fa-check"></i><b>12.1</b> 简单读取文件</a></li>
<li class="chapter" data-level="12.2" data-path="data-import.html"><a href="data-import.html#解析向量"><i class="fa fa-check"></i><b>12.2</b> 解析向量</a></li>
<li class="chapter" data-level="12.3" data-path="data-import.html"><a href="data-import.html#数字类型"><i class="fa fa-check"></i><b>12.3</b> 数字类型</a></li>
<li class="chapter" data-level="12.4" data-path="data-import.html"><a href="data-import.html#字符类型"><i class="fa fa-check"></i><b>12.4</b> 字符类型</a></li>
<li class="chapter" data-level="12.5" data-path="data-import.html"><a href="data-import.html#因子类型"><i class="fa fa-check"></i><b>12.5</b> 因子类型</a></li>
<li class="chapter" data-level="12.6" data-path="data-import.html"><a href="data-import.html#日期时间类型"><i class="fa fa-check"></i><b>12.6</b> 日期时间类型</a></li>
<li class="chapter" data-level="12.7" data-path="data-import.html"><a href="data-import.html#解析文件"><i class="fa fa-check"></i><b>12.7</b> 解析文件</a>
<ul>
<li class="chapter" data-level="12.7.1" data-path="data-import.html"><a href="data-import.html#自动匹配"><i class="fa fa-check"></i><b>12.7.1</b> 自动匹配</a></li>
<li class="chapter" data-level="12.7.2" data-path="data-import.html"><a href="data-import.html#自动匹配遇到的问题"><i class="fa fa-check"></i><b>12.7.2</b> 自动匹配遇到的问题</a></li>
<li class="chapter" data-level="12.7.3" data-path="data-import.html"><a href="data-import.html#其他的匹配解决策略"><i class="fa fa-check"></i><b>12.7.3</b> 其他的匹配解决策略</a></li>
</ul></li>
<li class="chapter" data-level="12.8" data-path="data-import.html"><a href="data-import.html#写入数据"><i class="fa fa-check"></i><b>12.8</b> 写入数据</a>
<ul>
<li class="chapter" data-level="12.8.1" data-path="data-import.html"><a href="data-import.html#csv-格式"><i class="fa fa-check"></i><b>12.8.1</b> csv 格式</a></li>
<li class="chapter" data-level="12.8.2" data-path="data-import.html"><a href="data-import.html#rds-格式"><i class="fa fa-check"></i><b>12.8.2</b> rds 格式</a></li>
<li class="chapter" data-level="12.8.3" data-path="data-import.html"><a href="data-import.html#feather-格式"><i class="fa fa-check"></i><b>12.8.3</b> feather 格式</a></li>
<li class="chapter" data-level="12.8.4" data-path="data-import.html"><a href="data-import.html#其他格式"><i class="fa fa-check"></i><b>12.8.4</b> 其他格式</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="tidy-data.html"><a href="tidy-data.html"><i class="fa fa-check"></i><b>13</b> Tidy data</a>
<ul>
<li class="chapter" data-level="13.1" data-path="tidy-data.html"><a href="tidy-data.html#对-table1-数据分析"><i class="fa fa-check"></i><b>13.1</b> 对 table1 数据分析</a></li>
<li class="chapter" data-level="13.2" data-path="tidy-data.html"><a href="tidy-data.html#对-table2-数据整理"><i class="fa fa-check"></i><b>13.2</b> 对 table2 数据整理</a></li>
<li class="chapter" data-level="13.3" data-path="tidy-data.html"><a href="tidy-data.html#对-table3-数据整理"><i class="fa fa-check"></i><b>13.3</b> 对 table3 数据整理</a></li>
<li class="chapter" data-level="13.4" data-path="tidy-data.html"><a href="tidy-data.html#对-table4a-table4b-数据整理"><i class="fa fa-check"></i><b>13.4</b> 对 table4a &amp; table4b 数据整理</a></li>
<li class="chapter" data-level="13.5" data-path="tidy-data.html"><a href="tidy-data.html#对-table5-数据整理"><i class="fa fa-check"></i><b>13.5</b> 对 table5 数据整理</a></li>
<li class="chapter" data-level="13.6" data-path="tidy-data.html"><a href="tidy-data.html#对-stocks-和-treatment-的缺失数据处理"><i class="fa fa-check"></i><b>13.6</b> 对 stocks 和 treatment 的缺失数据处理</a></li>
<li class="chapter" data-level="13.7" data-path="tidy-data.html"><a href="tidy-data.html#对-who-数据整理"><i class="fa fa-check"></i><b>13.7</b> 对 who 数据整理</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="relational-data.html"><a href="relational-data.html"><i class="fa fa-check"></i><b>14</b> Relational data</a>
<ul>
<li class="chapter" data-level="14.1" data-path="relational-data.html"><a href="relational-data.html#理解合并数据概念"><i class="fa fa-check"></i><b>14.1</b> 理解合并数据概念</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="relational-data.html"><a href="relational-data.html#类型1没有重复问题"><i class="fa fa-check"></i><b>14.1.1</b> 类型1：没有重复问题</a></li>
<li class="chapter" data-level="14.1.2" data-path="relational-data.html"><a href="relational-data.html#类型2一边有重复问题"><i class="fa fa-check"></i><b>14.1.2</b> 类型2：一边有重复问题</a></li>
<li class="chapter" data-level="14.1.3" data-path="relational-data.html"><a href="relational-data.html#类型3两边都有重复问题"><i class="fa fa-check"></i><b>14.1.3</b> 类型3：两边都有重复问题</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="relational-data.html"><a href="relational-data.html#理解多种数据合并方式"><i class="fa fa-check"></i><b>14.2</b> 理解多种数据合并方式</a></li>
<li class="chapter" data-level="14.3" data-path="relational-data.html"><a href="relational-data.html#设置操作"><i class="fa fa-check"></i><b>14.3</b> 设置操作</a></li>
<li class="chapter" data-level="14.4" data-path="relational-data.html"><a href="relational-data.html#合并-nycflights-数据并分析"><i class="fa fa-check"></i><b>14.4</b> 合并 nycflights 数据并分析</a></li>
</ul></li>
<li class="part"><span><b>III Model 模型</b></span></li>
<li class="chapter" data-level="15" data-path="model-intro.html"><a href="model-intro.html"><i class="fa fa-check"></i><b>15</b> Introduction</a>
<ul>
<li class="chapter" data-level="15.1" data-path="model-intro.html"><a href="model-intro.html#认知"><i class="fa fa-check"></i><b>15.1</b> 认知</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="model-basics.html"><a href="model-basics.html"><i class="fa fa-check"></i><b>16</b> Model basics</a>
<ul>
<li class="chapter" data-level="16.1" data-path="model-basics.html"><a href="model-basics.html#对-sim1-模型研究"><i class="fa fa-check"></i><b>16.1</b> 对 sim1 模型研究</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="model-basics.html"><a href="model-basics.html#简单建立-sim1-模型"><i class="fa fa-check"></i><b>16.1.1</b> 简单建立 sim1 模型</a></li>
<li class="chapter" data-level="16.1.2" data-path="model-basics.html"><a href="model-basics.html#对-sim1-模型可视化观察分析"><i class="fa fa-check"></i><b>16.1.2</b> 对 sim1 模型可视化观察分析</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="model-basics.html"><a href="model-basics.html#对-sim2-模型研究"><i class="fa fa-check"></i><b>16.2</b> 对 sim2 模型研究</a>
<ul>
<li class="chapter" data-level="16.2.1" data-path="model-basics.html"><a href="model-basics.html#关于-model_matrix"><i class="fa fa-check"></i><b>16.2.1</b> 关于 model_matrix()</a></li>
</ul></li>
<li class="chapter" data-level="16.3" data-path="model-basics.html"><a href="model-basics.html#对-sim3分类变量模型研究"><i class="fa fa-check"></i><b>16.3</b> 对 sim3（分类变量）模型研究</a></li>
<li class="chapter" data-level="16.4" data-path="model-basics.html"><a href="model-basics.html#对-sim4连续且相互作用模型研究"><i class="fa fa-check"></i><b>16.4</b> 对 sim4（连续且相互作用）模型研究</a>
<ul>
<li class="chapter" data-level="16.4.1" data-path="model-basics.html"><a href="model-basics.html#关于-seq_range"><i class="fa fa-check"></i><b>16.4.1</b> 关于 seq_range()</a></li>
<li class="chapter" data-level="16.4.2" data-path="model-basics.html"><a href="model-basics.html#对-sim4-模型可视化绘图"><i class="fa fa-check"></i><b>16.4.2</b> 对 sim4 模型可视化绘图</a></li>
</ul></li>
<li class="chapter" data-level="16.5" data-path="model-basics.html"><a href="model-basics.html#对-sim5模型转换模型研究"><i class="fa fa-check"></i><b>16.5</b> 对 sim5（模型转换）模型研究</a>
<ul>
<li class="chapter" data-level="16.5.1" data-path="model-basics.html"><a href="model-basics.html#关于-i-和-model_matrix续"><i class="fa fa-check"></i><b>16.5.1</b> 关于 I() 和 model_matrix()（续）</a></li>
<li class="chapter" data-level="16.5.2" data-path="model-basics.html"><a href="model-basics.html#关于-poly"><i class="fa fa-check"></i><b>16.5.2</b> 关于 poly()</a></li>
<li class="chapter" data-level="16.5.3" data-path="model-basics.html"><a href="model-basics.html#关于-ns"><i class="fa fa-check"></i><b>16.5.3</b> 关于 ns()</a></li>
<li class="chapter" data-level="16.5.4" data-path="model-basics.html"><a href="model-basics.html#na-值缺少值问题"><i class="fa fa-check"></i><b>16.5.4</b> NA 值（缺少值）问题</a></li>
</ul></li>
<li class="chapter" data-level="16.6" data-path="model-basics.html"><a href="model-basics.html#其他常见线性模型"><i class="fa fa-check"></i><b>16.6</b> 其他常见线性模型</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="model-building.html"><a href="model-building.html"><i class="fa fa-check"></i><b>17</b> Model building</a>
<ul>
<li class="chapter" data-level="17.1" data-path="model-building.html"><a href="model-building.html#分析-diamonds-品质与价格反常的原因"><i class="fa fa-check"></i><b>17.1</b> 分析 diamonds 品质与价格反常的原因</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="model-building.html"><a href="model-building.html#重量与价格"><i class="fa fa-check"></i><b>17.1.1</b> 重量与价格</a></li>
<li class="chapter" data-level="17.1.2" data-path="model-building.html"><a href="model-building.html#推广出更复杂的模型"><i class="fa fa-check"></i><b>17.1.2</b> 推广出更复杂的模型</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="model-building.html"><a href="model-building.html#分析-flights-每日航班数量变化因素"><i class="fa fa-check"></i><b>17.2</b> 分析 flights 每日航班数量变化因素</a>
<ul>
<li class="chapter" data-level="17.2.1" data-path="model-building.html"><a href="model-building.html#星期几对航班的影响"><i class="fa fa-check"></i><b>17.2.1</b> 星期几对航班的影响</a></li>
<li class="chapter" data-level="17.2.2" data-path="model-building.html"><a href="model-building.html#季节性周六效应"><i class="fa fa-check"></i><b>17.2.2</b> 季节性周六效应</a></li>
<li class="chapter" data-level="17.2.3" data-path="model-building.html"><a href="model-building.html#针对一年中的不同时间点"><i class="fa fa-check"></i><b>17.2.3</b> 针对一年中的不同时间点</a></li>
</ul></li>
<li class="chapter" data-level="17.3" data-path="model-building.html"><a href="model-building.html#关于计算变量"><i class="fa fa-check"></i><b>17.3</b> 关于计算变量</a></li>
<li class="chapter" data-level="17.4" data-path="model-building.html"><a href="model-building.html#有关模型的更多信息"><i class="fa fa-check"></i><b>17.4</b> 有关模型的更多信息</a></li>
</ul></li>
<li class="part"><span><b>IV Communicate 沟通</b></span></li>
<li class="chapter" data-level="18" data-path="introduction-1.html"><a href="introduction-1.html"><i class="fa fa-check"></i><b>18</b> Introduction</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">由 Bookdown 强力驱动</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R-Learning</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-building" class="section level1 hasAnchor" number="17">
<h1><span class="header-section-number">Chapter 17</span> Model building<a href="model-building.html#model-building" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>上一章我们侧重于模拟数据集。本章将重点介绍真实数据，以及如何构建模型以便理解数据。我们可以将数据划分为模式和残差模型。注意模型建立有时不尽人意，有时建立得很好但你不知道为什么。</p>
<p>如果你遇到了任何困惑 —— 请不要畏惧重新开始！换个全新思路可能对你非常有用。</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="model-building.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb230-2"><a href="model-building.html#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelr)</span>
<span id="cb230-3"><a href="model-building.html#cb230-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">na.action =</span> na.warn)</span>
<span id="cb230-4"><a href="model-building.html#cb230-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-5"><a href="model-building.html#cb230-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nycflights13)</span>
<span id="cb230-6"><a href="model-building.html#cb230-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code></pre></div>
<div id="分析-diamonds-品质与价格反常的原因" class="section level2 hasAnchor" number="17.1">
<h2><span class="header-section-number">17.1</span> 分析 diamonds 品质与价格反常的原因<a href="model-building.html#分析-diamonds-品质与价格反常的原因" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>还记得我们之前研究的奇怪现象吗？品质越差的钻石，价格越高。不只是质量，在颜色、纯净度方面都是这样表现的：</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="model-building.html#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(cut, price)) <span class="sc">+</span></span>
<span id="cb231-2"><a href="model-building.html#cb231-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/geom_boxplot()%20with%20diamonds-1.png" width="672" /></p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="model-building.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(color, price)) <span class="sc">+</span></span>
<span id="cb232-2"><a href="model-building.html#cb232-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/geom_boxplot()%20with%20diamonds-2.png" width="672" /></p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="model-building.html#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(clarity, price)) <span class="sc">+</span></span>
<span id="cb233-2"><a href="model-building.html#cb233-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/geom_boxplot()%20with%20diamonds-3.png" width="672" /></p>
<p>注意最差的钻石颜色是 J（微黄色），最差的纯净度是 I1（肉眼可见的杂物）。</p>
<div id="重量与价格" class="section level3 hasAnchor" number="17.1.1">
<h3><span class="header-section-number">17.1.1</span> 重量与价格<a href="model-building.html#重量与价格" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="model-building.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds, <span class="fu">aes</span>(carat, price)) <span class="sc">+</span></span>
<span id="cb234-2"><a href="model-building.html#cb234-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">50</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/geom_hex()%20with%20diamonds-1.png" width="672" /></p>
<p>我们决定对数据进行过滤处理：</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="model-building.html#cb235-1" aria-hidden="true" tabindex="-1"></a>diamonds_new <span class="ot">&lt;-</span> diamonds <span class="sc">%&gt;%</span></span>
<span id="cb235-2"><a href="model-building.html#cb235-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(carat <span class="sc">&lt;=</span> <span class="fl">2.5</span>) <span class="sc">%&gt;%</span> <span class="co"># 质量小于 2.5</span></span>
<span id="cb235-3"><a href="model-building.html#cb235-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lprice =</span> <span class="fu">log2</span>(price), <span class="at">lcarat =</span> <span class="fu">log2</span>(carat)) <span class="co"># 对价格和质量取对数（基数为 2 的对数）</span></span>
<span id="cb235-4"><a href="model-building.html#cb235-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-5"><a href="model-building.html#cb235-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(lcarat, lprice)) <span class="sc">+</span></span>
<span id="cb235-6"><a href="model-building.html#cb235-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">50</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/diamonds_new-1.png" width="672" /></p>
<p>通过转化，它们的关系变成了明显漂亮的线性化！我们试着创建模型去拟合它：</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="model-building.html#cb236-1" aria-hidden="true" tabindex="-1"></a>mod_diamonds <span class="ot">&lt;-</span> <span class="fu">lm</span>(lprice <span class="sc">~</span> lcarat, <span class="at">data =</span> diamonds_new)</span>
<span id="cb236-2"><a href="model-building.html#cb236-2" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> diamonds_new <span class="sc">%&gt;%</span></span>
<span id="cb236-3"><a href="model-building.html#cb236-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_grid</span>(<span class="at">carat =</span> <span class="fu">seq_range</span>(carat, <span class="dv">20</span>)) <span class="sc">%&gt;%</span> <span class="co"># 创建矩阵</span></span>
<span id="cb236-4"><a href="model-building.html#cb236-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lcarat =</span> <span class="fu">log2</span>(carat)) <span class="sc">%&gt;%</span> <span class="co"># 矩阵生成的 carat 也需要取对数</span></span>
<span id="cb236-5"><a href="model-building.html#cb236-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_predictions</span>(mod_diamonds, <span class="st">&quot;lprice&quot;</span>) <span class="sc">%&gt;%</span> <span class="co"># 预测</span></span>
<span id="cb236-6"><a href="model-building.html#cb236-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">price =</span> <span class="dv">2</span><span class="sc">^</span>lprice) <span class="co"># 将价格还原回去</span></span></code></pre></div>
<p>最后绘制数据图：</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="model-building.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(carat, price)) <span class="sc">+</span></span>
<span id="cb237-2"><a href="model-building.html#cb237-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb237-3"><a href="model-building.html#cb237-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> grid, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ggplot()%20with%20diamonds_new-1.png" width="672" /></p>
<p>这告诉我们一些关于这些数据的有趣信息：如果我们相信我们创造的模型，那么大钻石比预期的要便宜得多。</p>
<p>我们来分析残差的数据：</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="model-building.html#cb238-1" aria-hidden="true" tabindex="-1"></a>diamonds_new <span class="ot">&lt;-</span> diamonds_new <span class="sc">%&gt;%</span></span>
<span id="cb238-2"><a href="model-building.html#cb238-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_residuals</span>(mod_diamonds, <span class="st">&quot;lresid&quot;</span>) <span class="co"># 注意这里分析得到的数据是取过对数的</span></span>
<span id="cb238-3"><a href="model-building.html#cb238-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-4"><a href="model-building.html#cb238-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(lcarat, lresid)) <span class="sc">+</span></span>
<span id="cb238-5"><a href="model-building.html#cb238-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">50</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/residuals%20with%20diamonds_new-1.png" width="672" /></p>
<p>我们决定舍弃掉价格变量，因为 lrisid 变量可能有其他参考价值：</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="model-building.html#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(cut, lresid)) <span class="sc">+</span></span>
<span id="cb239-2"><a href="model-building.html#cb239-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ggplot()%20with%20cut%20&%20color%20&%20clarity%20with%20diamonds_new-1.png" width="672" /></p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="model-building.html#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(color, lresid)) <span class="sc">+</span></span>
<span id="cb240-2"><a href="model-building.html#cb240-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ggplot()%20with%20cut%20&%20color%20&%20clarity%20with%20diamonds_new-2.png" width="672" /></p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="model-building.html#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(clarity, lresid)) <span class="sc">+</span></span>
<span id="cb241-2"><a href="model-building.html#cb241-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ggplot()%20with%20cut%20&%20color%20&%20clarity%20with%20diamonds_new-3.png" width="672" /></p>
<p>现在我们看到了所期望的结果：钻石品质越高，其相对价格也越高。</p>
</div>
<div id="推广出更复杂的模型" class="section level3 hasAnchor" number="17.1.2">
<h3><span class="header-section-number">17.1.2</span> 推广出更复杂的模型<a href="model-building.html#推广出更复杂的模型" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>既然价格对数与质量对数、颜色、质量和品质都有重要关系，那我们不妨把它们都加入模型：</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="model-building.html#cb242-1" aria-hidden="true" tabindex="-1"></a>mod_diamond_new <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb242-2"><a href="model-building.html#cb242-2" aria-hidden="true" tabindex="-1"></a>    lprice <span class="sc">~</span> lcarat <span class="sc">+</span> color <span class="sc">+</span> cut <span class="sc">+</span> clarity,</span>
<span id="cb242-3"><a href="model-building.html#cb242-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> diamonds_new</span>
<span id="cb242-4"><a href="model-building.html#cb242-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb242-5"><a href="model-building.html#cb242-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-6"><a href="model-building.html#cb242-6" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> diamonds_new <span class="sc">%&gt;%</span></span>
<span id="cb242-7"><a href="model-building.html#cb242-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 用 data_grid() 来创建数据越来越麻烦了。</span></span>
<span id="cb242-8"><a href="model-building.html#cb242-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 好在我们有一个叫 “.model” 的参数帮我们完成：</span></span>
<span id="cb242-9"><a href="model-building.html#cb242-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_grid</span>(cut, <span class="at">.model =</span> mod_diamond_new) <span class="sc">%&gt;%</span></span>
<span id="cb242-10"><a href="model-building.html#cb242-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_predictions</span>(mod_diamond_new)</span>
<span id="cb242-11"><a href="model-building.html#cb242-11" aria-hidden="true" tabindex="-1"></a>grid</span>
<span id="cb242-12"><a href="model-building.html#cb242-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 5 x 5</span></span>
<span id="cb242-13"><a href="model-building.html#cb242-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   cut       lcarat color clarity  pred</span></span>
<span id="cb242-14"><a href="model-building.html#cb242-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;ord&gt;      &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span id="cb242-15"><a href="model-building.html#cb242-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 Fair      -0.515 G     VS2      11.2</span></span>
<span id="cb242-16"><a href="model-building.html#cb242-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 Good      -0.515 G     VS2      11.3</span></span>
<span id="cb242-17"><a href="model-building.html#cb242-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 Very Good -0.515 G     VS2      11.4</span></span>
<span id="cb242-18"><a href="model-building.html#cb242-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 Premium   -0.515 G     VS2      11.4</span></span>
<span id="cb242-19"><a href="model-building.html#cb242-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 Ideal     -0.515 G     VS2      11.4</span></span>
<span id="cb242-20"><a href="model-building.html#cb242-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-21"><a href="model-building.html#cb242-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(grid, <span class="fu">aes</span>(cut, pred)) <span class="sc">+</span></span>
<span id="cb242-22"><a href="model-building.html#cb242-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/mod_diamond_new-1.png" width="672" /></p>
<p>如果模型需要我们未显式提供的变量，data_grid() 将自动使用 “典型值” 填充它们。对于连续变量，它使用中位数，分类变量使用最常见的值（如果存在并列，则使用或值）。</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="model-building.html#cb243-1" aria-hidden="true" tabindex="-1"></a>diamonds_new <span class="ot">&lt;-</span> diamonds_new <span class="sc">%&gt;%</span></span>
<span id="cb243-2"><a href="model-building.html#cb243-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 新的 lrisid 添加了颜色、质量和品质关系</span></span>
<span id="cb243-3"><a href="model-building.html#cb243-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_residuals</span>(mod_diamond_new, <span class="st">&quot;lresid_new&quot;</span>)</span>
<span id="cb243-4"><a href="model-building.html#cb243-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-5"><a href="model-building.html#cb243-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(diamonds_new, <span class="fu">aes</span>(lcarat, lresid_new)) <span class="sc">+</span></span>
<span id="cb243-6"><a href="model-building.html#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">50</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ggplot()%20with%20lresid_new-1.png" width="672" /></p>
<p>我们会发现有一些钻石数据的残差相当大 —— 尤其是因为取对数的关系，残差为 2 表示钻石的价格是我们预期的 4 倍。单独查看异常值通常很有用：</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="model-building.html#cb244-1" aria-hidden="true" tabindex="-1"></a>diamonds_new <span class="sc">%&gt;%</span></span>
<span id="cb244-2"><a href="model-building.html#cb244-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">abs</span>(lresid_new) <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># 残差绝对值大于 1</span></span>
<span id="cb244-3"><a href="model-building.html#cb244-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_predictions</span>(mod_diamond_new) <span class="sc">%&gt;%</span> <span class="co"># 对这些数据生成期望值对数</span></span>
<span id="cb244-4"><a href="model-building.html#cb244-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pred =</span> <span class="fu">round</span>(<span class="dv">2</span><span class="sc">^</span>pred)) <span class="sc">%&gt;%</span> <span class="co"># 对期望值反对数并取整</span></span>
<span id="cb244-5"><a href="model-building.html#cb244-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(price, pred, carat<span class="sc">:</span>table, x<span class="sc">:</span>z) <span class="sc">%&gt;%</span> <span class="co"># 重新选取需要的数据</span></span>
<span id="cb244-6"><a href="model-building.html#cb244-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(price) <span class="co"># 按照价格排列</span></span>
<span id="cb244-7"><a href="model-building.html#cb244-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 16 x 11</span></span>
<span id="cb244-8"><a href="model-building.html#cb244-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    price  pred carat cut       color clarity depth table     x     y     z</span></span>
<span id="cb244-9"><a href="model-building.html#cb244-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;ord&gt;     &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb244-10"><a href="model-building.html#cb244-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1  1013   264  0.25 Fair      F     SI2      54.4    64  4.3   4.23  2.32</span></span>
<span id="cb244-11"><a href="model-building.html#cb244-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2  1186   284  0.25 Premium   G     SI2      59      60  5.33  5.28  3.12</span></span>
<span id="cb244-12"><a href="model-building.html#cb244-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3  1186   284  0.25 Premium   G     SI2      58.8    60  5.33  5.28  3.12</span></span>
<span id="cb244-13"><a href="model-building.html#cb244-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4  1262  2644  1.03 Fair      E     I1       78.2    54  5.72  5.59  4.42</span></span>
<span id="cb244-14"><a href="model-building.html#cb244-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5  1415   639  0.35 Fair      G     VS2      65.9    54  5.57  5.53  3.66</span></span>
<span id="cb244-15"><a href="model-building.html#cb244-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6  1415   639  0.35 Fair      G     VS2      65.9    54  5.57  5.53  3.66</span></span>
<span id="cb244-16"><a href="model-building.html#cb244-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7  1715   576  0.32 Fair      F     VS2      59.6    60  4.42  4.34  2.61</span></span>
<span id="cb244-17"><a href="model-building.html#cb244-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8  1776   412  0.29 Fair      F     SI1      55.8    60  4.48  4.41  2.48</span></span>
<span id="cb244-18"><a href="model-building.html#cb244-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9  2160   314  0.34 Fair      F     I1       55.8    62  4.72  4.6   2.6 </span></span>
<span id="cb244-19"><a href="model-building.html#cb244-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10  2366   774  0.3  Very Good D     VVS2     60.6    58  4.33  4.35  2.63</span></span>
<span id="cb244-20"><a href="model-building.html#cb244-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11  3360  1373  0.51 Premium   F     SI1      62.7    62  5.09  4.96  3.15</span></span>
<span id="cb244-21"><a href="model-building.html#cb244-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12  3807  1540  0.61 Good      F     SI2      62.5    65  5.36  5.29  3.33</span></span>
<span id="cb244-22"><a href="model-building.html#cb244-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 13  3920  1705  0.51 Fair      F     VVS2     65.4    60  4.98  4.9   3.23</span></span>
<span id="cb244-23"><a href="model-building.html#cb244-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 14  4368  1705  0.51 Fair      F     VVS2     60.7    66  5.21  5.11  3.13</span></span>
<span id="cb244-24"><a href="model-building.html#cb244-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 15 10011  4048  1.01 Fair      D     SI2      64.6    58  6.25  6.2   4.02</span></span>
<span id="cb244-25"><a href="model-building.html#cb244-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 16 10470 23622  2.46 Premium   E     SI2      59.7    59  8.82  8.76  5.25</span></span></code></pre></div>
<p>似乎没有什么出人意料的数据，但可能值得花时间考虑，这是否表明我们的模型存在问题，或者数据中存在错误。</p>
</div>
</div>
<div id="分析-flights-每日航班数量变化因素" class="section level2 hasAnchor" number="17.2">
<h2><span class="header-section-number">17.2</span> 分析 flights 每日航班数量变化因素<a href="model-building.html#分析-flights-每日航班数量变化因素" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>按照天来看，这是一个包含 365 项的简单数据集：</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="model-building.html#cb245-1" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> flights <span class="sc">%&gt;%</span></span>
<span id="cb245-2"><a href="model-building.html#cb245-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 同理我们还有 make_datetime，作用是将日期各因素拼接，并返回 “日期” 格式数据</span></span>
<span id="cb245-3"><a href="model-building.html#cb245-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">make_date</span>(year, month, day)) <span class="sc">%&gt;%</span></span>
<span id="cb245-4"><a href="model-building.html#cb245-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb245-5"><a href="model-building.html#cb245-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>())</span>
<span id="cb245-6"><a href="model-building.html#cb245-6" aria-hidden="true" tabindex="-1"></a>daily</span>
<span id="cb245-7"><a href="model-building.html#cb245-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 365 x 2</span></span>
<span id="cb245-8"><a href="model-building.html#cb245-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    date           n</span></span>
<span id="cb245-9"><a href="model-building.html#cb245-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;date&gt;     &lt;int&gt;</span></span>
<span id="cb245-10"><a href="model-building.html#cb245-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 2013-01-01   842</span></span>
<span id="cb245-11"><a href="model-building.html#cb245-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 2013-01-02   943</span></span>
<span id="cb245-12"><a href="model-building.html#cb245-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 2013-01-03   914</span></span>
<span id="cb245-13"><a href="model-building.html#cb245-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 2013-01-04   915</span></span>
<span id="cb245-14"><a href="model-building.html#cb245-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 2013-01-05   720</span></span>
<span id="cb245-15"><a href="model-building.html#cb245-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 2013-01-06   832</span></span>
<span id="cb245-16"><a href="model-building.html#cb245-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 2013-01-07   933</span></span>
<span id="cb245-17"><a href="model-building.html#cb245-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 2013-01-08   899</span></span>
<span id="cb245-18"><a href="model-building.html#cb245-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 2013-01-09   902</span></span>
<span id="cb245-19"><a href="model-building.html#cb245-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 2013-01-10   932</span></span>
<span id="cb245-20"><a href="model-building.html#cb245-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 355 more rows</span></span>
<span id="cb245-21"><a href="model-building.html#cb245-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-22"><a href="model-building.html#cb245-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(date, n)) <span class="sc">+</span></span>
<span id="cb245-23"><a href="model-building.html#cb245-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/daily-1.png" width="672" /></p>
<p>不难发现，航班书总是呈现出周期性变化。我们接下来按星期几划分。</p>
<div id="星期几对航班的影响" class="section level3 hasAnchor" number="17.2.1">
<h3><span class="header-section-number">17.2.1</span> 星期几对航班的影响<a href="model-building.html#星期几对航班的影响" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="model-building.html#cb246-1" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> daily <span class="sc">%&gt;%</span></span>
<span id="cb246-2"><a href="model-building.html#cb246-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 对指定的日期来返回星期几（label 配置项为是否要用当地语言表示,默认 FALSE 用数字表示）</span></span>
<span id="cb246-3"><a href="model-building.html#cb246-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">wday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>))</span>
<span id="cb246-4"><a href="model-building.html#cb246-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(wday, n)) <span class="sc">+</span> <span class="co"># 注意这里默认周末排最前</span></span>
<span id="cb246-5"><a href="model-building.html#cb246-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/wday-1.png" width="672" /></p>
<p>双休日的航班相对要少些，因为大多数旅行都是商务旅行。这种影响在周六尤为明显：你有时可能会在周日离开去参加周一上午的会议，但你很少在周六离开，因为你更愿意在家和家人们在一起。</p>
<p>消除这种影响最简单的方法是使用模型矫正。首先，我们拟合模型，并将其预测覆盖在原始数据上来可视化：</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="model-building.html#cb247-1" aria-hidden="true" tabindex="-1"></a>mod_wday <span class="ot">&lt;-</span> <span class="fu">lm</span>(n <span class="sc">~</span> wday, <span class="at">data =</span> daily)</span>
<span id="cb247-2"><a href="model-building.html#cb247-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-3"><a href="model-building.html#cb247-3" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> daily <span class="sc">%&gt;%</span></span>
<span id="cb247-4"><a href="model-building.html#cb247-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_grid</span>(wday) <span class="sc">%&gt;%</span></span>
<span id="cb247-5"><a href="model-building.html#cb247-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_predictions</span>(mod_wday, <span class="st">&quot;n&quot;</span>)</span>
<span id="cb247-6"><a href="model-building.html#cb247-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-7"><a href="model-building.html#cb247-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(wday, n)) <span class="sc">+</span></span>
<span id="cb247-8"><a href="model-building.html#cb247-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb247-9"><a href="model-building.html#cb247-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> grid, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">4</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/mod_wday-1.png" width="672" /></p>
<p>这样，我们就把问题转化为分析残差：</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="model-building.html#cb248-1" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> daily <span class="sc">%&gt;%</span></span>
<span id="cb248-2"><a href="model-building.html#cb248-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_residuals</span>(mod_wday)</span>
<span id="cb248-3"><a href="model-building.html#cb248-3" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb248-4"><a href="model-building.html#cb248-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, resid)) <span class="sc">+</span></span>
<span id="cb248-5"><a href="model-building.html#cb248-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ref_line</span>(<span class="at">h =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># 基线调整到 0 而不是最小</span></span>
<span id="cb248-6"><a href="model-building.html#cb248-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/risid%20with%20wday%20with%20daily-1.png" width="672" /></p>
<p>现在，通过星期几预估模型，我们发现航班数量仍然明显偏离了预期航班数量。虽然现在我们已经消除了大部分大的每周效应，但我们仍然可以看到一些更微妙的变化：有没有一种可能，我是说可能，这个模型的变化不只是单纯的被星期几？</p>
<p>从6月份开始，我们的模型很是失败。为一周中的每一天绘制一条线，使原因更容易看到：</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="model-building.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(date, resid, <span class="at">colour =</span> wday)) <span class="sc">+</span></span>
<span id="cb249-2"><a href="model-building.html#cb249-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ref_line</span>(<span class="at">h =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb249-3"><a href="model-building.html#cb249-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/resid%20with%20daily%20with%20wday-1.png" width="672" /></p>
<p>有些线条仍然在乱飞！尤其是周六的航班数量：夏季的航班比我们预期的要多，秋季的航班则少得多。之后我们会着重分析。</p>
<p>这里将偏离过大的 “异常” 数据单独取出仔细研究：</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="model-building.html#cb250-1" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb250-2"><a href="model-building.html#cb250-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(resid <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">100</span>)</span>
<span id="cb250-3"><a href="model-building.html#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 11 x 4</span></span>
<span id="cb250-4"><a href="model-building.html#cb250-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    date           n wday  resid</span></span>
<span id="cb250-5"><a href="model-building.html#cb250-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;date&gt;     &lt;int&gt; &lt;ord&gt; &lt;dbl&gt;</span></span>
<span id="cb250-6"><a href="model-building.html#cb250-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 2013-01-01   842 周二  -109.</span></span>
<span id="cb250-7"><a href="model-building.html#cb250-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 2013-01-20   786 周日  -105.</span></span>
<span id="cb250-8"><a href="model-building.html#cb250-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 2013-05-26   729 周日  -162.</span></span>
<span id="cb250-9"><a href="model-building.html#cb250-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 2013-07-04   737 周四  -229.</span></span>
<span id="cb250-10"><a href="model-building.html#cb250-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 2013-07-05   822 周五  -145.</span></span>
<span id="cb250-11"><a href="model-building.html#cb250-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 2013-09-01   718 周日  -173.</span></span>
<span id="cb250-12"><a href="model-building.html#cb250-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 2013-11-28   634 周四  -332.</span></span>
<span id="cb250-13"><a href="model-building.html#cb250-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 2013-11-29   661 周五  -306.</span></span>
<span id="cb250-14"><a href="model-building.html#cb250-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 2013-12-24   761 周二  -190.</span></span>
<span id="cb250-15"><a href="model-building.html#cb250-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 2013-12-25   719 周三  -244.</span></span>
<span id="cb250-16"><a href="model-building.html#cb250-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11 2013-12-31   776 周二  -175.</span></span></code></pre></div>
<p>请注意这些日期并不是巧合。从美国公共假日角度来看，我们会发现这些数据包含元旦、美国独立日（7月4日）、感恩节和圣诞节。</p>
<p>而除上述个别突出的数据以外，也有一些整体性的趋势：</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="model-building.html#cb251-1" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb251-2"><a href="model-building.html#cb251-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, resid)) <span class="sc">+</span></span>
<span id="cb251-3"><a href="model-building.html#cb251-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ref_line</span>(<span class="at">h =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb251-4"><a href="model-building.html#cb251-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">colour =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span></span>
<span id="cb251-5"><a href="model-building.html#cb251-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">span =</span> <span class="fl">0.20</span>)</span>
<span id="cb251-6"><a href="model-building.html#cb251-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</span></span></code></pre></div>
<p><img src="24-model-building_files/figure-html/date%20with%20daily-1.png" width="672" /></p>
<p>冬季（12月至3月）的航班相对较少，而夏季（5月至9月）的航班明显更多。尽管我们只有一年的数据，没有更好地佐证这个观点。但我们可以通过思考获取潜在的解释。</p>
</div>
<div id="季节性周六效应" class="section level3 hasAnchor" number="17.2.2">
<h3><span class="header-section-number">17.2.2</span> 季节性周六效应<a href="model-building.html#季节性周六效应" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>之前我们发现仅周六在周预测模型对于全年数据中，出现明显偏差。这里专门提取进行研究：</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="model-building.html#cb252-1" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb252-2"><a href="model-building.html#cb252-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(wday <span class="sc">==</span> <span class="st">&quot;周六&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb252-3"><a href="model-building.html#cb252-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 如果是英语作为 R 的语言设置的话：filter(wday == &quot;Sat&quot;) %&gt;%</span></span>
<span id="cb252-4"><a href="model-building.html#cb252-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, n)) <span class="sc">+</span></span>
<span id="cb252-5"><a href="model-building.html#cb252-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb252-6"><a href="model-building.html#cb252-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb252-7"><a href="model-building.html#cb252-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 对 x 轴的缩放比例进行调整，其中数据类型为 date</span></span>
<span id="cb252-8"><a href="model-building.html#cb252-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(</span>
<span id="cb252-9"><a href="model-building.html#cb252-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;月份&quot;</span>, <span class="co"># 比例尺名称</span></span>
<span id="cb252-10"><a href="model-building.html#cb252-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_breaks =</span> <span class="st">&quot;1 month&quot;</span>, <span class="co"># 间隔为一个月</span></span>
<span id="cb252-11"><a href="model-building.html#cb252-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_labels =</span> <span class="st">&quot;%b&quot;</span> <span class="co"># 指定展示规范为仅显示月</span></span>
<span id="cb252-12"><a href="model-building.html#cb252-12" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/saturday%20with%20daily-1.png" width="672" /></p>
<p>同样是周六，不同的周六反馈的数据差异巨大！很难不会引起怀疑 —— 这是由暑假引起的：</p>
<p>当地人们通常在夏天去度假，也不介意选择周六度假。选择这个时间段度假，很可能是因为孩子们正好在放暑假。所以我们有理由推测暑假是从6月初到8月下旬。
实际查询数据我们得到，该州在2013年的暑假安排是6月26日至9月9日。但为什么春季的周六航班比秋季多？调研得知计划秋天度假的家庭实在不太常见，因为感恩节和圣诞节假期真的已经足够长。</p>
<p>让我们创建一个大致包含三个学校学期的 “term” 变量，并用一个函数来验证我们的推论：</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="model-building.html#cb253-1" aria-hidden="true" tabindex="-1"></a>term <span class="ot">&lt;-</span> <span class="cf">function</span>(date) {</span>
<span id="cb253-2"><a href="model-building.html#cb253-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cut 会切割我们本有的数据集，break 确认切割点位</span></span>
<span id="cb253-3"><a href="model-building.html#cb253-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cut</span>(date,</span>
<span id="cb253-4"><a href="model-building.html#cb253-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks =</span> <span class="fu">ymd</span>(<span class="dv">20130101</span>, <span class="dv">20130605</span>, <span class="dv">20130825</span>, <span class="dv">20140101</span>), <span class="co"># 创建日期向量</span></span>
<span id="cb253-5"><a href="model-building.html#cb253-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;spring&quot;</span>, <span class="st">&quot;summer&quot;</span>, <span class="st">&quot;fall&quot;</span>) <span class="co"># 切割后类别的命名标签</span></span>
<span id="cb253-6"><a href="model-building.html#cb253-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb253-7"><a href="model-building.html#cb253-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb253-8"><a href="model-building.html#cb253-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-9"><a href="model-building.html#cb253-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 通过切割获取学期标签</span></span>
<span id="cb253-10"><a href="model-building.html#cb253-10" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> daily <span class="sc">%&gt;%</span></span>
<span id="cb253-11"><a href="model-building.html#cb253-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">term =</span> <span class="fu">term</span>(date))</span>
<span id="cb253-12"><a href="model-building.html#cb253-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-13"><a href="model-building.html#cb253-13" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb253-14"><a href="model-building.html#cb253-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(wday <span class="sc">==</span> <span class="st">&quot;周六&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb253-15"><a href="model-building.html#cb253-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, n, <span class="at">colour =</span> term)) <span class="sc">+</span></span>
<span id="cb253-16"><a href="model-building.html#cb253-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb253-17"><a href="model-building.html#cb253-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb253-18"><a href="model-building.html#cb253-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(<span class="at">name =</span> <span class="st">&quot;月份&quot;</span>, <span class="at">date_breaks =</span> <span class="st">&quot;1 month&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%b&quot;</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/term-1.png" width="672" /></p>
<p>不同季节学期之间的断层非常明显！学生一旦处于暑假，周六出行度假的数量就会居高不下。</p>
<p>我们试着把这个规律推广到其他星期几：</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="model-building.html#cb254-1" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb254-2"><a href="model-building.html#cb254-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(wday, n, <span class="at">colour =</span> term)) <span class="sc">+</span></span>
<span id="cb254-3"><a href="model-building.html#cb254-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/term%20with%20wday-1.png" width="672" /></p>
<p>每个星期几都呈现这样的趋势：春季数据多变（由于节日，春季开头与结尾差异较大）、夏季（数据）航班偏多。周六用于暑假度假的趋势也很明显。</p>
<p>既然同时存在两个因素，我们不妨建立两个模型进行对比：</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="model-building.html#cb255-1" aria-hidden="true" tabindex="-1"></a>mod_wday <span class="ot">&lt;-</span> <span class="fu">lm</span>(n <span class="sc">~</span> wday, <span class="at">data =</span> daily)</span>
<span id="cb255-2"><a href="model-building.html#cb255-2" aria-hidden="true" tabindex="-1"></a>mod_wday_term <span class="ot">&lt;-</span> <span class="fu">lm</span>(n <span class="sc">~</span> wday <span class="sc">*</span> term, <span class="at">data =</span> daily)</span>
<span id="cb255-3"><a href="model-building.html#cb255-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-4"><a href="model-building.html#cb255-4" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb255-5"><a href="model-building.html#cb255-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gather_residuals</span>(<span class="at">without_term =</span> mod_wday, <span class="at">with_term =</span> mod_wday_term) <span class="sc">%&gt;%</span></span>
<span id="cb255-6"><a href="model-building.html#cb255-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, resid, <span class="at">colour =</span> model)) <span class="sc">+</span></span>
<span id="cb255-7"><a href="model-building.html#cb255-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ref_line</span>(<span class="at">h =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb255-8"><a href="model-building.html#cb255-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.75</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/mod_day%20&%20mod_wday_term-1.png" width="672" /></p>
<p>其实这里就已经表现出来了，包含 term 的模型的预期效果明显优于不包含的。接下来我们将模型与实际数据对应上：</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="model-building.html#cb256-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> daily <span class="sc">%&gt;%</span></span>
<span id="cb256-2"><a href="model-building.html#cb256-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_grid</span>(wday, term) <span class="sc">%&gt;%</span></span>
<span id="cb256-3"><a href="model-building.html#cb256-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gather_predictions</span>(</span>
<span id="cb256-4"><a href="model-building.html#cb256-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">without_term =</span> mod_wday,</span>
<span id="cb256-5"><a href="model-building.html#cb256-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">with_term =</span> mod_wday_term,</span>
<span id="cb256-6"><a href="model-building.html#cb256-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">.pred =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb256-7"><a href="model-building.html#cb256-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb256-8"><a href="model-building.html#cb256-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-9"><a href="model-building.html#cb256-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(daily, <span class="fu">aes</span>(wday, n)) <span class="sc">+</span></span>
<span id="cb256-10"><a href="model-building.html#cb256-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb256-11"><a href="model-building.html#cb256-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> grid, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb256-12"><a href="model-building.html#cb256-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(term <span class="sc">~</span> model)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ggplot()%20with%20with_term%20&%20without_term%20&%20term-1.png" width="672" /></p>
<p>我们的模型总是在走向一个我们所期望的 “寻常态”，但很不幸元数据有许多非常突出的异常值，以至于我们的预测值与理想值相去甚远。所以我们提出了新函数 <code>MASS::rlm()</code> 来合理处理异常值。</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="model-building.html#cb257-1" aria-hidden="true" tabindex="-1"></a>mod_wday_term_rlm <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">rlm</span>(n <span class="sc">~</span> wday <span class="sc">*</span> term, <span class="at">data =</span> daily) <span class="co"># 用法与 lm() 真的很类似</span></span>
<span id="cb257-2"><a href="model-building.html#cb257-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-3"><a href="model-building.html#cb257-3" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb257-4"><a href="model-building.html#cb257-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gather_residuals</span>(mod_wday_term_rlm, mod_wday_term) <span class="sc">%&gt;%</span></span>
<span id="cb257-5"><a href="model-building.html#cb257-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, resid)) <span class="sc">+</span></span>
<span id="cb257-6"><a href="model-building.html#cb257-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb257-7"><a href="model-building.html#cb257-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">colour =</span> model), <span class="at">alpha =</span> <span class="fl">0.7</span>)</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/mod_wday_term_rlm-1.png" width="672" /></p>
<p>新的模型可能更容易看到长期趋势和异常值。</p>
</div>
<div id="针对一年中的不同时间点" class="section level3 hasAnchor" number="17.2.3">
<h3><span class="header-section-number">17.2.3</span> 针对一年中的不同时间点<a href="model-building.html#针对一年中的不同时间点" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>我们可以使用一个更为灵活的模型，用来捕获我们感兴趣的内容。一个简单的线性趋势是不够的，我们可以尝试使用自然样条来拟合全年的平滑曲线：</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="model-building.html#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines) <span class="co"># 便于使用自然样条函数 ns()</span></span>
<span id="cb258-2"><a href="model-building.html#cb258-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">rlm</span>(n <span class="sc">~</span> wday <span class="sc">*</span> <span class="fu">ns</span>(date, <span class="dv">5</span>), <span class="at">data =</span> daily) <span class="co"># 最高 5 次方</span></span>
<span id="cb258-3"><a href="model-building.html#cb258-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-4"><a href="model-building.html#cb258-4" aria-hidden="true" tabindex="-1"></a>daily <span class="sc">%&gt;%</span></span>
<span id="cb258-5"><a href="model-building.html#cb258-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data_grid</span>(</span>
<span id="cb258-6"><a href="model-building.html#cb258-6" aria-hidden="true" tabindex="-1"></a>        wday, <span class="co"># 针对列 wday 生成新的无重复数据的基础数据列</span></span>
<span id="cb258-7"><a href="model-building.html#cb258-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> <span class="fu">seq_range</span>(date, <span class="at">n =</span> <span class="dv">20</span>) <span class="co"># 将 date 范围等距切割出 20 个点位</span></span>
<span id="cb258-8"><a href="model-building.html#cb258-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb258-9"><a href="model-building.html#cb258-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_predictions</span>(mod) <span class="sc">%&gt;%</span></span>
<span id="cb258-10"><a href="model-building.html#cb258-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(date, pred, <span class="at">colour =</span> wday)) <span class="sc">+</span></span>
<span id="cb258-11"><a href="model-building.html#cb258-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb258-12"><a href="model-building.html#cb258-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="24-model-building_files/figure-html/ns()%20with%20daily-1.png" width="672" /></p>
</div>
</div>
<div id="关于计算变量" class="section level2 hasAnchor" number="17.3">
<h2><span class="header-section-number">17.3</span> 关于计算变量<a href="model-building.html#关于计算变量" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>在我们试验多个模型和可视化效果时，最好将变量的创建捆绑到一个函数中，如：</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="model-building.html#cb259-1" aria-hidden="true" tabindex="-1"></a>compute_vars <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb259-2"><a href="model-building.html#cb259-2" aria-hidden="true" tabindex="-1"></a>    data <span class="sc">%&gt;%</span></span>
<span id="cb259-3"><a href="model-building.html#cb259-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb259-4"><a href="model-building.html#cb259-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">term =</span> <span class="fu">term</span>(date),</span>
<span id="cb259-5"><a href="model-building.html#cb259-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">wday =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>)</span>
<span id="cb259-6"><a href="model-building.html#cb259-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb259-7"><a href="model-building.html#cb259-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb259-8"><a href="model-building.html#cb259-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 或者将转换直接放在模型公式中：</span></span>
<span id="cb259-9"><a href="model-building.html#cb259-9" aria-hidden="true" tabindex="-1"></a>wday2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">wday</span>(x, <span class="at">label =</span> <span class="cn">TRUE</span>)</span>
<span id="cb259-10"><a href="model-building.html#cb259-10" aria-hidden="true" tabindex="-1"></a>mod3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(n <span class="sc">~</span> <span class="fu">wday2</span>(date) <span class="sc">*</span> <span class="fu">term</span>(date), <span class="at">data =</span> daily)</span></code></pre></div>
<p>这两种方法都是合理的。但如果要画图或检查变量，显式转换可能更好。但请不要随意使用返回多个列的转换（如样条曲线）。</p>
</div>
<div id="有关模型的更多信息" class="section level2 hasAnchor" number="17.4">
<h2><span class="header-section-number">17.4</span> 有关模型的更多信息<a href="model-building.html#有关模型的更多信息" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>我们只是触及了建模表层的一些东西，也获得了一些简单通用的工具，用于改善自己的数据分析。
从简单开始是可以的！但正如所看到的那样，即使是非常简单的模型，也会对你梳理变量之间相互作用的能力产生巨大的影响。
下面有一些很棒的书籍；建模确实值得一本书，所以我强烈建议你至少读其中的任意一本：</p>
<ul>
<li><p><em>Statistical Modeling: A Fresh Approach</em> by <em>Danny Kaplan</em></p>
<blockquote>
<p>👉 <a href="http://project-mosaic-books.com/?page_id=13">书本官网</a>（已挂，但保有 <a href="https://web.archive.org/web/20201207153442/http://project-mosaic-books.com/">Archive 历史版本</a>）</p>
<p>👉 <a href="https://www.amazon.com/Statistical-Modeling-Approach-Project-MOSAIC-ebook/dp/B073WDBJ57/">电子版购买（亚马逊）</a></p>
<p>👉 <a href="https://dtkaplan.github.io/SM2-bookdown/">在线阅读</a></p>
<p>本书温和地（。？）介绍了建模，我们可以在其中并行构建直觉，数学工具和一些关于 R 的小技巧。同时这本书取代了传统的 “统计学导论” 课程，提供了一个全新的与数据科学相关的课程。</p>
</blockquote></li>
<li><p><em>An Introduction to Statistical Learning</em> by <em>Gareth James, Daniela Witten, Trevor Hastie</em></p>
<blockquote>
<p>👉 <a href="http://www-bcf.usc.edu/~gareth/ISL/">作者官网</a> | <a href="https://www.statlearning.com/">书本官网</a></p>
<p>👉 电子版下载：<a href="https://hastie.su.domains/ISLR2/ISLRv2_website.pdf">PDF</a> | <a href="https://link.springer.com/download/epub/10.1007/978-1-4614-7138-7.epub">EPUB</a></p>
<p>👉 <a href="https://www.statlearning.com/resources-second-edition">教学资源文件下载</a></p>
<p>本书介绍了一系列现代建模技术，统称为统计学习。
要更深入地了解模型背后的数学原理，则请阅读：
<em>The Elements of Statistical Learning</em> by <em>Trevor Hastie, Robert Tibshirani, and Jerome Friedman</em>（电子版下载：<a href="https://web.stanford.edu/~hastie/Papers/ESLII.pdf">一代版本</a> | <a href="http://hastie.su.domains/ElemStatLearn/printings/ESLII_print12_toc.pdf">二代版本</a>）</p>
</blockquote></li>
<li><p><em>Applied Predictive Modeling</em> by <em>Max Kuhn</em> and <em>Kjell Johnson</em></p>
<blockquote>
<p>👉 <a href="http://appliedpredictivemodeling.com">书本官网</a></p>
<p>👉 <a href="https://www.amazon.com/Applied-Predictive-Modeling-Max-Kuhn/dp/1461468485?SubscriptionId=0ENGV10E9K9QDNSJ5C82&amp;linkCode=xm2">电子版购买（亚马逊）</a></p>
<p>本书更多是配套于 caret 包，为应对现实生活中的预测建模挑战提供了相当丰富的实用工具。</p>
</blockquote></li>
</ul>
<p>一个可能对你有用的下载集合：<a href="https://hastie.su.domains/pub.htm">Trevor Hastie - Publications (su.domains)</a></p>

</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="model-basics.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="introduction-1.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cworld1/r-learning/edit/master/book/24-model-building.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": [["book.pdf", "PDF"], ["book.epub", "EPUB"]],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
}
});
});
</script>

</body>

</html>
